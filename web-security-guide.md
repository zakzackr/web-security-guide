# Web Security Guide

# Cookie

## Cookie の設定方法

## Coooki の不適切な利用による脆弱性

### 概要

複数のページで使用したいデータを Cookie に保管すると、意図しない形で脆弱性につながることがある。

古典的なセッション管理（サーバーサイドセッション）を使用するアプリケーションにおいて、ユーザー ID やユーザーの権限情報を Cookie に保管すると、利用者が Cookie の値を書き換えることで、権限外の操作ができるようになってしまう。
基本的には、Session ID のみを Cookie に保管し、ユーザー ID や権限情報は、サーバー側のメモリやデータベースで管理する。

# リダイレクトに関する脆弱性

## 1. オープンリダイレクト脆弱性

### 概要

具体例として、クエリパラメータの next の値をそのままレスポンスヘッダにセットする実装が Web アプリに存在する場合を考える。

まず攻撃者が、以下のリンクをメールや SNS などで拡散する。`example.com`の利用者がそのリンクを踏んでログインすると、next パラメータで指定したパスにリダイレクトする。リダイレクト先の罠ページで個人情報を入力すると、個人情報が漏洩する。（フィッシング）

`https://example.com/login?next=https://evil.com/phishing`

### 原因

外部からリダイレクト先の URL を指定できる場合に脆弱性が生まれる。

### 対策

-   リダイレクト先の URL を固定する
-   リダイレクト先の URL をそのまま指定せず、番号指定する
-   リダイレクト先の URL をチェックし、許可された URL にのみ遷移する

## 2. HTTP ヘッダ・インジェクション（CRLF インジェクション）

### 概要

具体例として、クエリパラメータの next の値をそのままレスポンスヘッダにセットする実装が Web アプリに存在する場合を考える。

まず攻撃者が、以下のリンクをメールや SNS などで拡散する。

`https://example.com/login?next=/dashboard%0d%0aLocation:https://evil.com`

`example.com` の利用者がそのリンクを踏んでログインすると、dashboard に遷移するはずが、URL に改行（`%0d%0a`）が含まれることで、Location ヘッダが二重で生成され、最後の Location ヘッダのみがレスポンスとして返される。それにより、罠ページである`https://evil.com`に遷移する。

```
Location: /dashboard
Location: https://evil.com
```

その他にも、攻撃者が`%0d%0aSet-Cookie:+SESSIONID=123`を URL に追加することで、Set-Cookie ヘッダをインジェクションし、レスポンスとして返却することで、任意の Cookie が利用者のブラウザに保存される。
それにより、**セッション ID の固定化攻撃**が可能になる。

また、以下のように URL に改行を２つ追加することで、任意のコンテンツをレスポンスボディとして返却し、ブラウザに表示させることも可能である。任意のコンテンツには、単なる文字列だけでなく、`<html></html> `や `<script></script>`も含まれるので、結果的に XSS 攻撃につながる。

`https://example.com/login?next=/dashboard%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E`

### 原因

HTTP ヘッダは、改行で各ヘッダが区切られ、１行に 1 つのヘッダを持つ構造をしている。そのため、改行をそのまま出力することで、HTTP ヘッダ・インジェクション脆弱性が生まれる。

### 対策

外部から入力されたパラメータをレスポンスヘッダとしてそのまま出力せず、Web 開発用の言語・フレームワークで提供されているヘッダ出力用 API を使用する。API が提供されていない場合は、開発者が改行文字を許可しない実装を行う。

### 参考

[安全なウェブサイトの作り方 - 1.7 HTTP ヘッダ・インジェクション
](https://www.ipa.go.jp/security/vuln/websecurity/http-header.html)

# メール送信機能に関する脆弱性

## メールヘッダ・インジェクション

### 概要

メール送信用フォームを持つ Web アプリで発生する脆弱性。

具体例として、以下のような問い合わせフォームを持つ Web アプリを考える。このフォームは、利用者のメールアドレスと本文を受け取り、Web アプリの管理者に問い合わせのメールを送信する。

```html
<form action="http://example.com" method="post">
    メールアドレス: <textarea name="from" rows="4"></textarea> 
    本文:<textarea name="body" rows="10"></textarea>
    <button type="submit">送信</button>
</form>
```

ユーザーがメールアドレス欄に以下のような入力をした場合、

```
alice@example.com
Bcc: bob@example.com
```

アプリケーションが改行を適切に処理しないままヘッダとして出力する場合、以下のようなメールヘッダが作成される。結果として、Bcc で第三者にメールを送信できてしまう。

```
From: alice@example.com
Bcc: bob@example.com
```

今回の例は宛先の追加だけだが、本文の改ざんや添付ファイル（ウイルスファイル）の送信も可能なので、それらを組み合わせることで、問い合わせフォーム経由で第三者に迷惑メールの送信が可能となる。

### 原因

メールメッセージの形式は HTTP と似た形式を持っている。具体的には、各ヘッダが改行で区切られ、空行の後にボディが続くという形式である。そのため、アプリケーションが外部から入力された改行付きのパラメータをヘッダとしてそのまま使用することで、脆弱性が生まれる。

### 対策

1. メール送信専用のライブラリを使用する
2. 外部から入力されたパラメータをヘッダで使用しない
3. 外部から入力されたパラメータに改行が含まれないかチェックする
4. 保険的対策として、件名とメールアドレスの入力値検証を行う
