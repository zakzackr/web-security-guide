# Web Security Guide

## リダイレクトに関する脆弱性

### 1. オープンリダイレクト脆弱性

#### 概要

具体例として、クエリパラメータの next の値をそのままレスポンスヘッダにセットする実装が Web アプリに存在する場合を考える。

まず攻撃者が、以下のリンクをメールや SNS などで拡散する。`example.com`の利用者がそのリンクを踏んでログインすると、next パラメータで指定したパスにリダイレクトする。リダイレクト先の罠ページで個人情報を入力すると、個人情報が漏洩する。（フィッシング）

`https://example.com/login?next=https://evil.com/phishing`

#### 原因

外部からリダイレクト先の URL を指定できる場合に脆弱性が生まれる。

#### 対策

-   リダイレクト先の URL を固定する
-   リダイレクト先の URL をそのまま指定せず、番号指定する
-   リダイレクト先の URL をチェックし、許可された URL にのみ遷移する

### 2. HTTP ヘッダ・インジェクション（CRLF インジェクション）

#### 概要

具体例として、クエリパラメータの next の値をそのままレスポンスヘッダにセットする実装が Web アプリに存在する場合を考える。

まず攻撃者が、以下のリンクをメールや SNS などで拡散する。

`https://example.com/login?next=/dashboard%0d%0aLocation:https://evil.com`

`example.com` の利用者がそのリンクを踏んでログインすると、dashboard に遷移するはずが、URL に改行（`%0d%0a`）が含まれることで、Location ヘッダが二重で生成され、最後の Location ヘッダのみがレスポンスとして返される。それにより、罠ページである`https://evil.com`に遷移する。

```
Location: /dashboard
Location: https://evil.com
```

その他にも、攻撃者が`%0d%0aSet-Cookie:+SESSIONID=123`を URL に追加することで、Set-Cookie ヘッダをインジェクションし、レスポンスとして返却することで、任意の Cookie が利用者のブラウザに保存される。
それにより、**セッション ID の固定化攻撃**が可能になる。

また、以下のように URL に改行を２つ追加することで、任意のコンテンツをレスポンスボディとして返却し、ブラウザに表示させることも可能である。

`https://example.com/login?next=/dashboard%0d%0a%0d%0a%3Cscript%3Ealert(1)%3C/script%3E`

任意のコンテンツには、単なる文字列だけでなく、`<html></html> `や `<script></script>`も含まれるので、結果的に XSS 攻撃につながる。

#### 原因

HTTP ヘッダは、改行で各ヘッダが区切られ、１行に 1 つのヘッダを持つ構造をしている。そのため、改行をそのまま出力することで、HTTP ヘッダ・インジェクション脆弱性が生まれる。

#### 対策

外部から入力されたパラメータをレスポンスヘッダとしてそのまま出力せず、Web 開発用の言語・フレームワークで提供されているヘッダ出力用 API を使用する。API が提供されていない場合は、開発者が改行文字を許可しない実装を行う。

#### 参考

[安全なウェブサイトの作り方 - 1.7 HTTP ヘッダ・インジェクション
](https://www.ipa.go.jp/security/vuln/websecurity/http-header.html)
